<!DOCTYPE html>
<html>
	<head>
		<script src="src/class.js" type="text/javascript"></script>
		<script src="src/options.js" type="text/javascript"></script>

		<script src="src/tab.js" type="text/javascript"></script>
		<script src="src/nudejs/worker.nude.js" type="text/javascript"></script>

		<script type="text/javascript">

			// From Prototype.js, modified slightly
			Function.prototype.bind = function(context)
			{
					if (arguments.length < 2 && typeof arguments[0] === "undefined") return this;
					var __method = this, args = Array.prototype.slice.call(arguments).slice(1);
					return function() {
							var a = args.concat(Array.prototype.slice.call(arguments));
							return __method.apply(context, a);
					}
			}
			
			var tabs = {},
				options = new Options(),
				nudejs = new NudeChecker();


			var canvas = document.createElement("canvas");
//			var b = document.getElementsByTagName("body")[0];
//			b.appendChild(canvas);
			var ctx = canvas.getContext("2d");

//			chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
//				// Remove old tab
//				if (tabs[tabId])
//				{
//					tabs[tabId].destroy();
//					delete tabs[tabId];
//				}
//
//				if (options.checkUrl(tab.url))
//				{
//					chrome.pageAction.show(tabId);
//					tabs[tabId] = new Tab(tabId);
//				}
//			});
//
//			chrome.tabs.onRemoved.addListener(function(tabId, changeInfo, tab) {
//				if (tabs[tabId])
//				{
//					tabs[tabId].destroy();
//					delete tabs[tabId];
//				}
//			});

			chrome.extension.onConnect.addListener(function(port) {
				console.assert(port.name == "kfw");
				console.log("Connecting to page!");

				port.onMessage.addListener(function(msg) {
					if ('img' in msg) {
						console.log("Checking " + msg.img.src);
						// apply the width and height to the canvas element
						canvas.width = msg.img.width;
						canvas.height = msg.img.height;
						// draw the image into the canvas element
						ctx.drawImage(msg.img, 0, 0);

						var result = nudejs.scanImage(
							ctx.getImageData(0, 0, canvas.width, canvas.height).data,
							canvas.width,
							canvas.height
						);
						console.log("Result for " + msg.img.src + ": " + result);
						port.postMessage({img: msg.img,  result: result});
					}
				});
			});

			chrome.pageAction.onClicked.addListener(function(tab) {
				if (!tabs[tab.id].enabled)
				{
					tabs[tab.id].enable();
				}
				else
				{
					tabs[tab.id].disable();
				}
			});
		</script>
	</head>
</html>